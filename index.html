<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>مدیریت موجودی انبارها</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .dark body {
            background-color: #111827; /* dark:bg-gray-900 */
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* NEW: Toast Styles */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #fff;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success {
            background-color: #059669; /* bg-green-600 */
        }
        .toast-error {
            background-color: #dc2626; /* bg-red-600 */
        }
    </style>
</head>
<body class="dark">
    <div id="root"></div>

    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = supabase;
        // NOTE: These are public keys and are safe to be exposed in client-side code.
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey, { global: { fetch: window.fetch.bind(window) } });

        // ==================================================
        // Helper UI Components
        // ==================================================
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay open" onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-600">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        // RE-ADDED: SearchableSelect Component
        const SearchableSelect = ({ options, value, onChange, placeholder, disabled = false }) => {
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isOpen, setIsOpen] = React.useState(false);
            const wrapperRef = React.useRef(null);

            const selectedOption = React.useMemo(() => options.find(opt => opt.id === value), [options, value]);

            const filteredOptions = React.useMemo(() => {
                if (!searchTerm) return options;
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                // Search by title or ID
                return options.filter(opt =>
                    opt.title.toLowerCase().includes(lowerCaseSearchTerm) ||
                    opt.id.toString().includes(lowerCaseSearchTerm)
                );
            }, [options, searchTerm]);

            React.useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                        setSearchTerm('');
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleSelect = (option) => {
                onChange(option.id);
                setSearchTerm('');
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <input
                        type="text"
                        placeholder={selectedOption ? selectedOption.title : placeholder}
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        onFocus={() => setIsOpen(true)}
                        disabled={disabled}
                        className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"
                    />
                    {isOpen && !disabled && (
                        <div className="absolute z-10 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <div
                                        key={option.id}
                                        onClick={() => handleSelect(option)}
                                        className="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-800 cursor-pointer"
                                    >
                                        {option.title}
                                    </div>
                                ))
                            ) : (
                                <div className="p-2 text-gray-500">موردی یافت نشد.</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        // NEW: Toast Component
        const Toast = ({ message, type, visible }) => {
            if (!visible) return null;
            const toastClass = type === 'success' ? 'toast-success' : 'toast-error';
            return (
                <div className={`toast ${visible ? 'show' : ''} ${toastClass}`}>
                    {message}
                </div>
            );
        };

        // ==================================================
        // Core Components for this App
        // ==================================================
        
        const InventoryManagementModal = ({ isOpen, onClose, location, products, showToast }) => { // MODIFIED: Added showToast
            const [inventory, setInventory] = React.useState([]);
            const [isLoading, setIsLoading] = React.useState(true);
            const [isSaving, setIsSaving] = React.useState(false); // NEW: Saving state
            const [error, setError] = React.useState('');
            const [formInfo, setFormInfo] = React.useState(''); // State for form-specific info/warnings
            const [newProductForm, setNewProductForm] = React.useState({ product_id: '', quantity: '', unitprice: '', is_available: true });
            const [highlightedProductId, setHighlightedProductId] = React.useState(null); // State to filter list
            const [productToDelete, setProductToDelete] = React.useState(null); // NEW: State for delete confirmation

            const fetchInventory = React.useCallback(async () => {
                if (!location) return;
                setIsLoading(true);
                setError('');
                try {
                    // Fetch all stock for this specific location, joining product details
                    const { data, error: stockError } = await supabaseClient
                        .from('supplierstock')
                        .select('*, product(id, title, brand(title), productproperty(*, propertykey(title)))')
                        .eq('location_id', location.id);
                    
                    if (stockError) throw stockError;
                    
                    setInventory(data || []);
                } catch (err) {
                    console.error("Error fetching inventory:", err);
                    setError(`خطا در بارگذاری موجودی: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            }, [location]);

            React.useEffect(() => {
                if (isOpen) {
                    fetchInventory();
                }
            }, [isOpen, fetchInventory]);
            
            // NEW: Handle local state changes for inventory items
            const handleLocalStockChange = (productId, field, value) => {
                let parsedValue = value;
                if (field === 'unitprice' || field === 'quantity') {
                    parsedValue = (value === '' ? null : Number(value));
                }
                setInventory(prev => 
                    prev.map(item => 
                        item.product.id === productId ? { ...item, [field]: parsedValue } : item
                    )
                );
            };

            // NEW: Save all changes and close modal
            const handleSaveAndExit = async () => {
                setIsSaving(true);
                setError('');
                try {
                    const updatePromises = inventory.map(item => 
                        supabaseClient
                            .from('supplierstock')
                            .update({ 
                                quantity: item.quantity,
                                unitprice: item.unitprice,
                                is_available: item.is_available 
                            })
                            .eq('location_id', location.id)
                            .eq('productid', item.product.id)
                    );
                    
                    const results = await Promise.all(updatePromises);
                    
                    const firstError = results.find(res => res.error);
                    if (firstError) {
                        throw firstError.error;
                    }

                    setIsSaving(false);
                    showToast('تغییرات با موفقیت ذخیره شد', 'success'); // NEW: Success toast
                    onClose(); // Close modal on success
                } catch (err) {
                    console.error("Error saving stock:", err);
                    setError(`خطا در ذخیره تغییرات: ${err.message}`);
                    showToast('خطا در ذخیره تغییرات', 'error'); // NEW: Error toast
                    setIsSaving(false);
                }
            };

            // RENAMED: from handleDeleteStock to handleConfirmDelete
            const handleConfirmDelete = async () => {
                if (!productToDelete) return;

                const productIdToDelete = productToDelete.product.id;
                
                // Optimistic UI update
                const oldInventory = [...inventory];
                setInventory(prev => prev.filter(item => item.product.id !== productIdToDelete));
                
                // Close the confirmation modal
                setProductToDelete(null); 

                const { error } = await supabaseClient
                    .from('supplierstock')
                    .delete()
                    .eq('location_id', location.id)
                    .eq('productid', productIdToDelete);
                
                if (error) {
                    setError(`خطا در حذف: ${error.message}`);
                    showToast('خطا در حذف محصول', 'error'); // NEW: Error toast
                    setInventory(oldInventory); // Revert on failure
                } else {
                    showToast('محصول با موفقیت حذف شد', 'success'); // NEW: Success toast
                    if (highlightedProductId === productIdToDelete) {
                        setHighlightedProductId(null);
                        setFormInfo('');
                        setNewProductForm({ product_id: '', quantity: '', unitprice: '', is_available: true });
                    }
                }
            };
            
            const handleAddProduct = async (e) => {
                // This remains an immediate action
                e.preventDefault();
                setFormInfo(''); 
                setError(''); 
                if (!newProductForm.product_id) {
                    setFormInfo('لطفا یک محصول انتخاب کنید.');
                    return;
                }

                const isAlreadyAdded = inventory.some(i => i.product.id === newProductForm.product_id);
                if (isAlreadyAdded) {
                    setFormInfo('این محصول در حال حاضر در انبار موجود است. نمی‌توانید آن را دوباره اضافه کنید.');
                    return; 
                }
                
                const { error } = await supabaseClient.from('supplierstock').insert({
                    location_id: location.id,
                    productid: newProductForm.product_id,
                    supplieruserid: location.supplier.id,
                    quantity: newProductForm.quantity === '' ? null : Number(newProductForm.quantity),
                    unitprice: newProductForm.unitprice === '' ? null : Number(newProductForm.unitprice),
                    is_available: newProductForm.is_available
                });
                if (error) {
                    setError(`خطا در افزودن محصول: ${error.message}`);
                    showToast('خطا در افزودن محصول', 'error'); // NEW: Error toast
                } else {
                    setNewProductForm({ product_id: '', quantity: '', unitprice: '', is_available: true });
                    setFormInfo(''); 
                    setHighlightedProductId(null); 
                    showToast('محصول با موفقیت اضافه شد', 'success'); // NEW: Success toast
                    fetchInventory(); // Refresh the list
                }
            };

            // NEW: Function to open the delete confirmation modal
            const requestDelete = (item) => {
                setProductToDelete(item);
            };

            const handleProductSelect = (id) => {
                setFormInfo(''); 
                setError(''); 
                if (!id) {
                    setNewProductForm({...newProductForm, product_id: ''});
                    setHighlightedProductId(null); 
                    return;
                }
                
                const isAlreadyAdded = inventory.some(i => i.product.id === id);
                if (isAlreadyAdded) {
                    setFormInfo('این محصول در حال حاضر در انبار موجود است. می‌توانید آن را در لیست پایین ویرایش کنید.');
                    setHighlightedProductId(id); 
                } else {
                    setHighlightedProductId(null); 
                }
                setNewProductForm({...newProductForm, product_id: id});
            };
            
            const allProductsForSelect = React.useMemo(() => { 
                return products
                    .map(p => {
                        const telegramCodeProp = p.productproperty?.find(
                            prop => prop.propertykey?.title === 'کد کالا (تلگرام)'
                        );
                        const telegramCode = telegramCodeProp ? telegramCodeProp.value : '';
                        const baseTitle = `${p.brand ? p.brand.title + ' ' : ''}${p.title}`;
                        const displayTitle = `${telegramCode ? `[${telegramCode}] ` : ''}${baseTitle} [Product ID = ${p.id}]`;
                        return { id: p.id, title: displayTitle };
                    });
            }, [products]); 

            const filteredInventory = React.useMemo(() => {
                if (highlightedProductId) {
                    return inventory.filter(item => item.product.id === highlightedProductId);
                }
                return inventory; // Return all if no highlight
            }, [inventory, highlightedProductId]);

            const warehouseAttr = location?.location_attribute_value?.find(attr => attr.location_attribute_key.title.toLowerCase().trim() === 'warehouse name');
            const warehouseName = warehouseAttr?.value || location?.title || 'انبار اصلی';
            const modalTitle = `مدیریت موجودی: ${location?.supplier?.fullname} - ${warehouseName} (کد: ${location?.id})`;

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={modalTitle}>
                    {isLoading && <div className="spinner"></div>}
                    {error && <p className="text-red-500 mb-4 p-3 bg-red-100 dark:bg-red-900/50 rounded-lg">{error}</p>}
                    {!isLoading && (
                        <div className="space-y-4">
                            {/* Add New Product Form */}
                            <form onSubmit={handleAddProduct} className="p-4 border border-gray-200 dark:border-gray-700 rounded-lg space-y-3 bg-gray-50 dark:bg-gray-800/50">
                                <h4 className="font-semibold">افزودن محصول جدید به انبار</h4>
                                {formInfo && <p className="text-yellow-500 text-sm p-2 bg-yellow-100 dark:bg-yellow-900/50 rounded-md">{formInfo}</p>}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <div className="md:col-span-2">
                                        <label className="text-sm block mb-1">محصول</label>
                                        <SearchableSelect options={allProductsForSelect} value={newProductForm.product_id} onChange={handleProductSelect} placeholder="انتخاب محصول..." />
                                    </div>
                                    <div>
                                        <label className="text-sm block mb-1">قیمت (تومان)</label>
                                        <input type="number" min="0" value={newProductForm.unitprice} onChange={e => setNewProductForm({...newProductForm, unitprice: e.target.value})} className="w-full bg-white dark:bg-gray-700 p-2 rounded-lg" />
                                    </div>
                                    <div>
                                        <label className="text-sm block mb-1">تعداد (اختیاری)</label>
                                        <input type="number" min="0" value={newProductForm.quantity} onChange={e => setNewProductForm({...newProductForm, quantity: e.target.value})} className="w-full bg-white dark:bg-gray-700 p-2 rounded-lg" />
                                    </div>
                                </div>
                                <div className="flex items-center justify-between pt-2">
                                    <label className="flex items-center gap-2 text-sm"><input type="checkbox" checked={newProductForm.is_available} onChange={e => setNewProductForm({...newProductForm, is_available: e.target.checked})} className="rounded" /> موجود</label>
                                    <button type="submit" className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">افزودن</button>
                                </div>
                            </form>

                            {/* Existing Inventory List */}
                            <div className="space-y-2 max-h-[50vh] overflow-y-auto pr-2">
                                {filteredInventory.map(item => { 
                                    const telegramCodeProp = item.product.productproperty?.find(
                                        prop => prop.propertykey?.title === 'کد کالا (تلگرام)'
                                    );
                                    const telegramCode = telegramCodeProp ? telegramCodeProp.value : '';
                                    return (
                                        <div key={item.product.id} className="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-md flex flex-wrap items-center justify-between gap-4">
                                            <span className="font-semibold flex-grow min-w-[200px]">{`${telegramCode ? `[${telegramCode}] ` : ''}${item.product.brand ? item.product.brand.title + ' ' : ''}${item.product.title} [Product ID = ${item.product.id}]`}</span>
                                            <div className="flex items-center gap-3 flex-wrap">
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    placeholder="قیمت" 
                                                    value={item.unitprice || ''} 
                                                    onChange={e => handleLocalStockChange(item.product.id, 'unitprice', e.target.value)} 
                                                    className="w-28 bg-white dark:bg-gray-600 p-1 rounded-md text-center" 
                                                />
                                                <input 
                                                    type="number" 
                                                    min="0" 
                                                    placeholder="تعداد" 
                                                    value={item.quantity || ''} 
                                                    onChange={e => handleLocalStockChange(item.product.id, 'quantity', e.target.value)} 
                                                    className="w-20 bg-white dark:bg-gray-600 p-1 rounded-md text-center" 
                                                />
                                                <label className="flex items-center gap-1 text-sm">
                                                    <input 
                                                        type="checkbox" 
                                                        checked={item.is_available} 
                                                        onChange={e => handleLocalStockChange(item.product.id, 'is_available', e.target.checked)} 
                                                        className="rounded" 
                                                    /> موجود
                                                </label>
                                                {/* MODIFIED: Calls requestDelete instead of handleConfirmDelete */}
                                                <button onClick={() => requestDelete(item)} className="text-red-500 hover:text-red-700 font-bold text-lg leading-none">×</button>
                                            </div>
                                        </div>
                                    )
                                })}
                                {inventory.length === 0 && <p className="text-center text-gray-500 py-4">موجودی برای این مکان ثبت نشده است.</p>}
                                {highlightedProductId && filteredInventory.length === 0 && inventory.length > 0 && (
                                    <p className="text-center text-gray-500 py-4">این محصول در لیست موجودی یافت نشد (ممکن است مشکلی رخ داده باشد).</p>
                                )}
                            </div>

                            {/* NEW: Modal Footer with Save Button */}
                            <div className="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3">
                                <button 
                                    onClick={onClose} 
                                    disabled={isSaving}
                                    className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg font-semibold disabled:opacity-50"
                                >
                                    انصراف
                                </button>
                                <button 
                                    onClick={handleSaveAndExit} 
                                    disabled={isSaving}
                                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold disabled:opacity-50 flex items-center gap-2"
                                >
                                    {isSaving ? (
                                        <>
                                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                                            ذخیره...
                                        </>
                                    ) : (
                                        'ذخیره و خروج'
                                    )}
                                </button>
                            </div>

                        </div>
                    )}

                    {/* NEW: Delete Confirmation Modal */}
                    <Modal 
                        isOpen={!!productToDelete} 
                        onClose={() => setProductToDelete(null)} 
                        title="تایید حذف محصول"
                    >
                        <div className="space-y-6">
                            <p>
                                آیا از حذف محصول زیر از این انبار اطمینان دارید؟
                                <br />
                                <strong className="block mt-2 font-semibold text-lg">
                                    {productToDelete?.product.brand ? productToDelete.product.brand.title + ' ' : ''}{productToDelete?.product.title}
                                </strong>
                            </p>
                            <p className="text-sm text-yellow-500 bg-yellow-100 dark:bg-yellow-900/50 p-3 rounded-lg">
                                این عملیات غیرقابل بازگشت است و محصول به طور کامل از موجودی این انبار حذف خواهد شد.
                            </p>
                            <div className="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <button
                                    onClick={() => setProductToDelete(null)}
                                    className="bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 px-4 py-2 rounded-lg font-semibold"
                                >
                                    انصراف
                                </button>
                                <button
                                    onClick={handleConfirmDelete}
                                    className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold"
                                >
                                    بله، حذف کن
                                </button>
                            </div>
                        </div>
                    </Modal>

                </Modal>
            );
        };
        
        const SupplierWarehouses = () => {
            const [isLoading, setIsLoading] = React.useState(true);
            const [error, setError] = React.useState('');
            
            // Data States
            const [supplierLocations, setSupplierLocations] = React.useState([]);
            const [products, setProducts] = React.useState([]);

            // Interaction States
            const [searchTerm, setSearchTerm] = React.useState('');
            const [managingLocation, setManagingLocation] = React.useState(null);

            // Modal States
            const [isInventoryModalOpen, setInventoryModalOpen] = React.useState(false);

            // NEW: Toast State
            const [toast, setToast] = React.useState({ message: '', type: '', visible: false, id: 0 });

            // NEW: Show Toast Function
            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToast({ message, type, visible: true, id });
                setTimeout(() => {
                    // Only hide if it's the same toast
                    setToast(currentToast => (currentToast.id === id ? { ...currentToast, visible: false } : currentToast));
                }, 3000);
            };

            const fetchData = async () => {
                setIsLoading(true);
                setError('');
                try {
                    // 1. Get the 'Supplier' role ID
                    const supplierRoleRes = await supabaseClient.from('role').select('id').eq('title', 'Supplier').single();
                    if (supplierRoleRes.error) throw supplierRoleRes.error;
                    const supplierRoleId = supplierRoleRes.data?.id;

                    if (!supplierRoleId) {
                        setSupplierLocations([]);
                        throw new Error("Role 'Supplier' not found.");
                    }
                    
                    // 2. Fetch all products (paginated to get all results)
                    const fetchAllProducts = async () => {
                        let allProducts = [];
                        let page = 0;
                        const pageSize = 1000; // Supabase limit per request
                        let keepFetching = true;

                        while (keepFetching) {
                            const { data, error } = await supabaseClient
                                .from('product')
                                .select('id, title, brand(title), productproperty(*, propertykey(title))')
                                .eq('isdeleted', false)
                                .order('title')
                                .range(page * pageSize, (page + 1) * pageSize - 1);

                            if (error) throw error;

                            if (data && data.length > 0) {
                                allProducts = allProducts.concat(data);
                                page++;
                                if (data.length < pageSize) {
                                    keepFetching = false;
                                }
                            } else {
                                keepFetching = false; // No more data
                            }
                        }
                        return allProducts;
                    };
                    
                    // 3. Fetch locations and all products in parallel
                    const [locationsRes, allProducts] = await Promise.all([
                        // Get all userlocations, joining where profile role is 'Supplier'
                        supabaseClient.from('userlocation').select('location!inner(*, city(*, province(*)), shippingcompany(*), location_attribute_value(*, location_attribute_key(title))), profiles!inner(id, fullname, roleid)').eq('profiles.roleid', supplierRoleId),
                        fetchAllProducts()
                    ]);

                    if (locationsRes.error) throw locationsRes.error;

                    // Set state with results
                    setSupplierLocations(locationsRes.data || []);
                    setProducts(allProducts || []);

                } catch (err) {
                    console.error("Error fetching data:", err);
                    setError(`خطا در بارگذاری اطلاعات: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };

            React.useEffect(() => {
                fetchData();
            }, []);

            const handleManageInventory = (location, supplier) => {
                // Combine location and supplier info for the modal
                setManagingLocation({ ...location, supplier });
                setInventoryModalOpen(true);
            };
            
            // Memoized filtering for search
            const filteredLocations = React.useMemo(() => {
                if (!searchTerm) return supplierLocations;
                return supplierLocations.filter(item => {
                    const searchTermLower = searchTerm.toLowerCase();
                    const supplierNameMatch = item.profiles?.fullname?.toLowerCase().includes(searchTermLower);
                    const cityMatch = item.location?.city?.title?.toLowerCase().includes(searchTermLower);
                    const addressMatch = item.location?.address?.toLowerCase().includes(searchTermLower);
                    return supplierNameMatch || cityMatch || addressMatch;
                });
            }, [supplierLocations, searchTerm]);

            return (
                 <div className="p-4 sm:p-6 lg:p-8 text-gray-900 dark:text-gray-100">
                    {/* NEW: Toast Container */}
                    <div className="toast-container">
                        <Toast message={toast.message} type={toast.type} visible={toast.visible} />
                    </div>

                    <h1 className="text-2xl md:text-3xl font-bold mb-6">مدیریت موجودی انبارها (مکان تامین‌کنندگان)</h1>
                    
                    <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6">
                        <input
                            type="text"
                            placeholder="جستجو بر اساس نام تامین‌کننده، شهر یا آدرس..."
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            className="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-transparent rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                    </div>

                    {isLoading && <div className="spinner"></div>}
                    {error && <p className="text-center p-8 text-red-500 bg-red-100 dark:bg-red-900/50 rounded-lg">{error}</p>}

                    {!isLoading && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {filteredLocations.length > 0 ? filteredLocations.map(item => {
                                // Find warehouse name from attributes
                                const warehouseAttr = item.location.location_attribute_value?.find(attr => attr.location_attribute_key.title.toLowerCase().trim() === 'warehouse name');
                                const warehouseName = warehouseAttr?.value || item.location.title || 'انبار اصلی';
                                
                                return (
                                <div key={item.location.id} className="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-5 flex flex-col justify-between transition-all hover:shadow-xl hover:-translate-y-1">
                                    <div>
                                        <h3 className="text-xl font-bold text-gray-900 dark:text-white">
                                            {item.profiles.fullname}
                                        </h3>
                                        <div className="mt-4 text-sm text-gray-600 dark:text-gray-300 space-y-2 border-t border-gray-200 dark:border-gray-700 pt-3">
                                            <p><strong>استان:</strong> {item.location.city?.province?.title || '-'}</p>
                                            <p><strong>شهر:</strong> {item.location.city?.title || '-'}</p>
                                            <p><strong>نام انبار:</strong> {warehouseName}</p>
                                            <p><strong>کد مکان:</strong> {item.location.id}</p>
                                            <p><strong>آدرس:</strong> {item.location.address || '-'}</p>
                                            <p><strong>کد پستی:</strong> {item.location.postalcode || '-'}</p>
                                        </div>
                                    </div>
                                    <div className="mt-5 pt-4 border-t border-gray-200 dark:border-gray-700 flex justify-end items-center gap-3">
                                        <button onClick={() => handleManageInventory(item.location, item.profiles)} className="w-full text-sm bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                                            مدیریت موجودی
                                        </button>
                                    </div>
                                </div>
                            )}) : 
                            <div className="col-span-full text-center py-12 bg-white dark:bg-gray-800 rounded-lg shadow">
                                <h3 className="text-lg font-medium text-gray-900 dark:text-gray-100">هیچ مکانی یافت نشد</h3>
                                <p className="mt-1 text-sm text-gray-500 dark:text-gray-400">مکانی برای تامین‌کنندگان با فیلترهای انتخابی شما مطابقت ندارد.</p>
                               </div>
                            }
                        </div>
                    )}
                    
                    {isInventoryModalOpen && managingLocation && (
                        <InventoryManagementModal 
                            key={managingLocation.id} // Ensure modal re-renders with new data
                            isOpen={isInventoryModalOpen} 
                            onClose={() => setInventoryModalOpen(false)} 
                            location={managingLocation} 
                            products={products} 
                            showToast={showToast} // MODIFIED: Pass showToast down
                        />
                    )}
                </div>
            );
        };
        
        const App = () => {
            // Theme management for dark/light mode
             React.useEffect(() => {
                const root = window.document.documentElement;
                root.classList.add('dark'); // Default to dark mode for this app
            }, []);
            
            return <SupplierWarehouses />;
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>




